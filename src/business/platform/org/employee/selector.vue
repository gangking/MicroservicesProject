<template>
  <div>
    <ibps-selector v-bind="$props" :items="items" @click="handleSelectorClick" @remove="handleSelectorRemove" />
    <!-- 选择器 -->
    <ibps-employee-selector-dialog :visible="selectorVisible" :value="selectorValue" :multiple="multiple" :type-id="typeId" :ground-id="groundId" @close="visible => selectorVisible = visible" @action-event="handleSelectorActionEvent" />
  </div>
</template>
<script>
import { get } from '@/api/platform/org/employee';
import { getByAccount } from '@/api/platform/org/user';
import { valueEquals } from 'element-ui/src/utils/util';
import emitter from 'element-ui/src/mixins/emitter';
import IbpsSelector from '@/components/ibps-selector/selector';
import IbpsEmployeeSelectorDialog from './dialog';

export default {
  components: {
    IbpsSelector,
    IbpsEmployeeSelectorDialog
  },
  inject: {
    elForm: {
      default: ''
    },
    elFormItem: {
      default: ''
    }
  },
  mixins: [emitter],
  props: {
    typeId: [String, Number],
    groundId: [String, Number],
    value: {
      type: [String, Number, Array]
    },
    // 存储类型 ：
    // ①、id:只存储id 字符串，
    // ②、json： json字符串,
    // ③、array：存储数组数据(完整数据，包含key和value)。
    // ④、bind：绑定ID，需要回调和返回
    store: {
      type: String,
      default: 'id',
      validator: function(value) {
        return ['id', 'json', 'array', 'arrayId', 'bind'].indexOf(value) !== -1;
      }
    },
    editeValue: {
      type: Object,
      default: () => {}
    },
    storeSeparator: {
      // 存储值分割符,对应[多选]有效，对于设置字符串类型的分隔符
      type: String,
      default: ','
    },
    placeholder: {
      // 输入框占位文本
      type: String,
      default: '请选择用户'
    },
    multiple: {
      // 是否多选
      type: Boolean,
      default: false
    },
    labelKey: {
      // 展示的值
      type: String,
      default: 'name'
    },
    valueKey: {
      // 存储唯一值
      type: String,
      default: 'id'
    },
    disabled: {
      // 禁用
      type: Boolean,
      default: false
    }
  },
  data() {
    return {
      selectorVisible: false,
      selectorValue: this.multiple ? [] : {},
      cacheData: {},
      bindIdValue: ''
    };
  },
  computed: {
    items() {
      console.log('选中的1', this.selectorValue);
      if (this.$utils.isEmpty(this.selectorValue)) return [];
      var itemVal = null;
      if (this.multiple) {
        itemVal = this.selectorValue.map(data => {
          return data[this.labelKey];
        });
        // return
      } else {
        itemVal = [this.selectorValue[this.labelKey]];
      }
      console.log('选中的', itemVal);
      return itemVal;
    }
  },
  watch: {
    value: {
      handler(val, oldVal) {
        console.log(
          'data:选fsdfsdfsdfk;lks;kfls择------------------------------------------------器',
          val
        );
        this.initData();
        if (!valueEquals(val, oldVal)) {
          this.dispatch('ElFormItem', 'el.form.change', val);
        }
      },
      immediate: true
    },
    editeValue: {
      handler(val) {
        this.selectorValue = val;
      },
      immediate: true
    }
  },
  methods: {
    /**
     * 初始化数据
     */
    initData() {
      console.log('初始化数据', this.value);
      const data = this.getArrayValue(this.value);

      this.selectorValue = this.multiple ? [] : {};
      if (this.$utils.isEmpty(data)) {
        return;
      }
      data.forEach(v => {
        if (this.cacheData[v]) {
          this.setSelectorValue(v);
        } else {
          this.getDataInfo(v);
        }
      });
    },
    setCacheData() {
      if (this.$utils.isEmpty(this.selectorValue)) return;
      const data = this.multiple ? this.selectorValue : [this.selectorValue];
      data.forEach(v => {
        this.cacheData[v[this.valueKey]] = v;
      });
    },
    setSelectorValue(v) {
      if (this.multiple) {
        this.selectorValue.push(this.cacheData[v]);
      } else {
        this.selectorValue = JSON.parse(JSON.stringify(this.cacheData[v]));
      }
    },

    /**
     * 获得数组数据
     */
    getArrayValue(value, bindId) {
      if (this.$utils.isEmpty(value)) {
        return [];
      }
      if (this.store === 'json') {
        // json
        try {
          const data = this.$utils.parseData(value);
          if (this.multiple) {
            return data.map(d => {
              return d[this.valueKey];
            });
          } else {
            return [data];
          }
        } catch (error) {
          console.warn(error);
          return [];
        }
      } else if (this.store === 'id') {
        // id
        return this.$utils.isString(value) ? value.split(this.storeSeparator) : [];
      } else if (this.store === 'bind') {
        // 绑定id
        if (this.$utils.isEmpty(bindId)) {
          return [];
        }
        return bindId.split(this.storeSeparator);
      } else {
        // array
        return value.map(d => {
          return d[this.valueKey];
        });
      }
    },
    getStoreValue(value) {
      const res = [];
      if (this.store === 'json') {
        // json
        if (this.$utils.isEmpty(value)) {
          return '';
        }
        if (this.multiple) {
          value.forEach(v => {
            const o = {};
            o[this.valueKey] = v[this.valueKey];
            o[this.labelKey] = v[this.labelKey];
            res.push(o);
          });
          return JSON.stringify(res);
        } else {
          const o = {};
          o[this.valueKey] = value[this.valueKey];
          o[this.labelKey] = value[this.labelKey];
          return JSON.stringify(o);
        }
      } else if (this.store === 'id') {
        // id
        if (this.$utils.isEmpty(value)) {
          return '';
        }
        if (this.multiple) {
          value.forEach(v => {
            res.push(v[this.valueKey]);
          });
        } else {
          res.push(value[this.valueKey]);
        }
        return res.join(this.storeSeparator);
      } else if (this.store === 'bind') {
        // 绑定id
        const res = [];
        const bindIdValue = [];
        value.forEach(v => {
          bindIdValue.push(v[this.valueKey]);
          res.push(v[this.labelKey]);
        });
        this.bindIdValue = bindIdValue.join(this.storeSeparator);

        return res.join(this.storeSeparator);
      } else {
        // 数组 array
        return value || [];
      }
    },
    getValue() {
      return this.getStoreValue(this.selectorValue);
    },
    /**
     * 通过ID获取数据
     */
    getDataInfo(id) {
      if (this.valueKey === 'id') {
        get({
          employeeId: id
        })
          .then(response => {
            const data = response.data;
            this.cacheData[data[this.valueKey]] = data;
            this.setSelectorValue(data[this.valueKey]);
          })
          .catch(() => {});
      } else if (this.valueKey === 'account') {
        getByAccount({
          account: id
        })
          .then(response => {
            const data = response.data;
            this.cacheData[data[this.valueKey]] = data;
            this.setSelectorValue(data[this.valueKey]);
          })
          .catch(() => {});
      }
    },

    // ===================事件处理=========

    handleSelectorClick() {
      this.selectorVisible = true;
      this.initData();
    },
    handleSelectorRemove(index) {
      if (this.multiple) {
        this.selectorValue.splice(index, 1);
      } else {
        this.selectorValue = {};
      }
      this.handleInput();
    },

    handleSelectorActionEvent(buttonKey, data) {
      switch (buttonKey) {
        case 'confirm': // 确定
          this.selectorVisible = false;
          this.selectorValue = data;
          this.setCacheData(); // 设置缓存数据
          this.handleInput();
          break;
      }
    },
    handleInput() {
      this.$emit('input', this.getValue());
      // 提供一个返回实体，提供调用
      this.$emit('callback', this.selectorValue);
    }
  }
};
</script>
